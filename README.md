This directory contains a complex Kubernetes policy written using Rust.

Given the following scenario:

> As an operator of a Kubernetes cluster where multiple groups of user have access to,
> I want to reserve some nodes to a specif list of groups,
> so that their workloads are not running on a node to which "untrusted" users have access to.

This scenario can be implemented by using the concepts of
[taints and tolerations](https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/)
which is built into Kubernetes.

Unfortunately Kubernetes doesn't have any built-in mechanism that can prevent
untrusted users from adding specially crafted `tolerations`.

This policy inspects the [AdmissionReview](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request)
objects generated by the Kubernetes API server and either accept or reject
them.

The policy can be used to inspect `CREATE` and `UPDATE` requests of
`Pod` resources.

# Configuration

The policy has no hard-coded value for neither the `toleration` nor the
`usernames` or `groups` that are entitled to use the toleration.

The code will read these settings from the environment variables:

  * `TOLERATION_KEY`: `key` of the toleration. Required.
  * `TOLERATION_OPERATOR`: `operator` of the toleration. Required.
  * `TOLERATION_EFFECT`: `effect` of the toleration. Required.
  * `ALLOWED_USERS`: comma separated list of users who are allowed to use
    this toleration. Optional.
  * `ALLOWED_GROUPS`: comma separated list of groups who are allowed to use
    this toleration. Optional.

# Requirements

Handle the rust installation using rustup.

```bash
$ rustup target add wasm32-wasi
```

The snippet above adds a new target called `wasm32-wasi`.

# Building

Use this command to build the WASM code:

```
$ make build
```

This will produce a `.wasm` file under `target/wasm32-wasi/release/`.

# Trying the policy

The policy is a stand-alone WASM module, you can invoke it in this way:

```bash
$ cat test_data/req_pod_with_toleration.json | wasmtime run --env TOLERATION_EFFECT="NoSchedule" \
               --env TOLERATION_KEY="example-key" \
               --env TOLERATION_OPERATOR="Exists" \
               --env ALLOWED_GROUPS="administrators" \
               target/wasm32-wasi/release/real-policy-rust.wasm
```

This will produce the following output:

```bash
{"accepted":false,"message":"User not allowed to create Pod objects with toleration: key: example-key, operator: Exists, effect: NoSchedule)"}
```

You can find more example files under the `test_data` directory.

# Benchmark

```
$ make bench
```
